[English](https://github.com/kotelnikov/mgos_telegram/blob/main/README.md) |
[Русский](https://github.com/kotelnikov/mgos_telegram/blob/main/README.ru-Ru.md)

# Mongoose OS Telegram Bot API library

## Краткое описание
Данная библиотека представляет собой простое API для организации Telegram бота для фреймворка [Mongoose OS](https://mongoose-os.com/) разработанного [Cesanta Software Ltd](https://cesanta.com/). 

Библиотека пригодится для проектов где необходимо управлять устройством путем отправки/получения текстовых команд через [Telegram Bot API](https://core.telegram.org/bots). Библиотека успешно протестирована на микроконтроллерах ESP8266 и ESP32 от [Espressif Systems](https://www.espressif.com/).

Для функционирования библиотеки в вашем проекте должно быть настроено подключение к сети интернет через [Wi-Fi](https://mongoose-os.com/docs/mongoose-os/api/net/wifi.md) или через мобильную связь [PPPOS](https://mongoose-os.com/docs/mongoose-os/api/net/pppos.md).

На данном этапе поддерживаются только текстовые сообщения на английском языке. В случае если в процессе работы библиотеки будут приходить сообщения на других языках или сообщения будут неподдерживаемых типов, то такие сообщения будут преобразовываться в обычные текстовые сообщения содержащие текст-заглушку - "Unsupported characters, or data type". В будущем в библиотеку будет добавляться новый функционал. 

Прошу обратить внимание, что библиотека в стадии beta тестирования. Любые рекомендации и замечания приветствуются! )))

## Как использовать библиотеку
### Включение библиотеки в проект и настройка конфигурации
В первую очередь необходимо включить библиотеку в проект путем добавления в файл `mos.yml` в секцию `libs` следующего кода:

```
libs:
  - origin: https://github.com/kotelnikov/mgos_telegram
    name: telegram
```

Далее необходимо сконфигурировать библиотеку путем добавления в файл `mos.yml` в секцию `config_schema` следующего кода:

```
config_schema:
  - ["telegram.enable", true]
  - ["telegram.token", "1111222333:YourTokenGoesHere"]
  - ["telegram.acl", "[111222333, -444555666]"]
  - ["telegram.echo_bot", false]
```
Описание конфигурации секции `config_schema`:

Property | Description
------------ | -------------
`telegram.token` | Данная настройка хранит токен для подключения к Telegram API и представляет собой строку. Если у Вас нет своего токена, вы можете получить его воспользовавшись инструкцией по ссылке https://core.telegram.org/bots#creating-a-new-bot
`telegram.acl` | Данная настройка хранит лист доступа пользователей. Настройка представлена строкой содержащей массив ID пользователей и чатов. Обратите внимание групповые чаты должны быть представлены элементом с префиксом "-", в качестве примера см. второй элемент массива в конфигурации приведенной выше. Если лист доступа пустой или пришедшее сообщение от пользователя или из группового чата который не прописан в листе, то такие сообщения будут игнорироваться. Узнать свой ID, можно подписавшись на бота `@myidbot` и спросив ID командой `/getid`.
`telegram.echo_bot` | Эта настройка включает/выключает режим эхо бота. Обратите внимание, что по умолчанию данный параметр установлен в значение "true", т.е. в рабочей конфигурации вы должны выключить данный режим в значение "false".  Данный режим можно использовать для проверки работоспособности, достаточно оставить данный режим включенным и не писать вообще никакого кода в `init.js` или `main.c`, в таком случае библиотека будет работать как попугай, присылая вам в ответ все, что вы отправляете сами. При этом важно обратить внимание на то, что в режиме эхо бота лист доступа `telegram.acl` все равно должен присутствовать, иначе входящие сообщения будут игнорироваться.

### Разработка с использованием mJS (Java Script движок для Mongoose OS)
Если вы предпочитаете при разработке использовать mJS (Java Script движок для Mongoose OS) то добавьте в свой файл `init.js` следующий пример:

```js
load("api_events.js");
load('api_telegram.js');

// Ниже описана функция обратного вызова, для обработки входящих сообщений
let tgb_msg_handler = function(ed, ud) {
  
    let resp = TGB.parse(ed);
    
    // Здесь обрабатывается команда '/start'
    if (resp.result.text === '/start') {
        print('Telegram: mJS "/start" handler');
        TGB.pub(resp.result.chat_id, 'Received command "/start"', null, null, null);
    }
    // Здесь обрабатывается команда '/status'
    else if (resp.result.text === '/status') {
        print('Telegram: mJS "/status" handler');
        TGB.pub(resp.result.chat_id, 'Received command "/status"', null, null, null);
    }
    // Здесь обрабатывается все другие команды
    else {
        print('Telegram: mJS "*" handler');
        TGB.pub(resp.result.chat_id, resp.result.text, null, null, null);
    }
};

// Ниже описана функция которая вызывается при наступлении события TGB.CONNECTED
// В ней мы подписываемся на текстовые  команды
let tgb_start_handler = function(ev, ed, ud) {
    
    // Подписка на вообще все команды
    TGB.sub('*', tgb_msg_handler, null);
    
    // Ниже пример подписки на конкретные команды
    //TGB.sub('/start', tgb_msg_handler, null);
    //TGB.sub('/status', tgb_msg_handler, null);
};

Event.addHandler(TGB.CONNECTED, tgb_start_handler, null);

```
#### Описание API mJS по взаимодействию с библиотекой:


`Event.addHandler(TGB.CONNECTED, callback, user_data)` Перед тем как мы сможем подписаться на какие-либо команды необходимо дождаться события `TGB.CONNECTED`, которое срабатывает при успешном подключении библиотеки к Telegram Bot API. При наступлении данного события запускается функция обратного вызова, в которой мы подписываемся на определенные или все сообщения отправленные боту.

Аргумент | Описание
------------ | -------------
`callback` | В данном аргументе передается указатель на функцию обратного вызова, в которой мы подписываемся на определенные или все сообщения отправленные боту.
`user_data` | В данном аргументе передается указатель на какой-либо пользовательский объект или иные данные, которые будут переданы в функцию обратного вызова при ее вызове. В случае если это не требуется, передайте `null` в качестве данного аргумента.


`TGB.sub(command_text, callback, user_data)` Данная функция позволяет подписываться на определенные или все команды направленные боту (можно провести аналогию с подпиской на MQTT топик). 

Аргумент | Описание
------------ | -------------
`command_text` | Аргумент содержит текстовую команду, на которую происходит подписка. Если мы не подписаны на какую либо команду, то библиотека будет игнорировать такие сообщения. Можно подписаться на много разных команд и обрабатывать их в одной или разных функциях обратного вызова. Также можно подписаться на все команды за один раз, для этого достаточно передать в качестве аргумента строку содержащую звездочку `'*'`, в таком случае все полученные сообщения независимо от текста будут направляться в функцию обратного вызова переданную при осуществлении подписки.
`callback` | В данном аргументе передается указатель на функцию обратного вызова, которая будет вызываться при поступлении сообщения с текстом переданным в аргументе `command_text`. При вызове данной функции в нее будут передаваться 2 аргумента `event_data` и `user_data`, аргумент `event_data` это собственно данные входящего сообщения, которое подлежит преобразованию в объект путем вызова вспомогательной функции `TGB.parse(event_data)`, а аргумент `user_data` это указатель переданный в параметре который описан ниже.
`user_data` | В данном аргументе передается указатель на какой-либо пользовательский объект или иные данные, которые будут переданы в функцию обратного вызова при ее вызове. В случае если это не требуется, передайте `null` в качестве данного аргумента.


`TGB.pub(chat_id, message_text, json_data, callback, user_data)` Данная функция позволяет отправлять простые текстовые сообщения пользователям или в групповые чаты через Telegram Bot API. Текстовые сообщения могут отправляться пользователю или в групповой чат.

Аргумент | Описание
------------ | -------------
`chat_id` | В данном аргументе передается id пользователя или группового чата куда отправляется сообщение. Также доступно With this argument you have to pass the chat/group id where you going to send current message, or you can leave it empty `''`, if you prefer to use native Telegram Bot API (see `json_data` argument description).
`message_text` | With this argument you have to pass the message text you need to send, or you can leave it empty `''`, if you prefer to use native Telegram Bot API (see `json_data` argument description).
`json_data` | Вы также можете отправить строку в формате JSON (для преобразования объекта в строку JSON можно использовать функцию JSON.stringify(obj), которая доступна в mJS), содержащую атрибуты для описанные в Telegram Bot API для метода SendMessage, см. описание:  https://core.telegram.org/bots/api#sendmessage. Если это не требуется передайте `null` в качестве данного аргумента.
`callback` | В данном аргументе передается указатель на функцию обратного вызова, которая будет вызываться при получении ответа на запрос об отправке данного сообщения полученного от Telegram Bot API. Как правило в случае успешной отправки назад возвращается само сообщение или сообщение об ошибке. Функция `TGB.parse()` может преобразовать такой ответ в читаемый объект. Если не требуется получать и обрабатывать ответ на вызов функции отправки сообщения передайте `null` в качестве данного аргумента.
`user_data` | В данном аргументе передается указатель на какой-либо пользовательский объект или иные данные, которые будут переданы в функцию обратного вызова для обработки ответа на запрос об отправке сообщения . В случае если это не требуется, передайте `null` в качестве данного аргумента.


`TGB.parse(event_data)` Данная функция используется для преобразование входящих сообщений в удобный для обработки формат объекта. Функция возвращает объект JS, содержащий следующие свойства:

Входящее сообщение:
```js
{
    ok: true,
    result: {
        message_id:1872,
        user_id: 222444555,
        chat_id: 222444555,
        text: 'Test message'
    }
} 
```

Сообщение об ошибке:
```js
{
    ok: false, 
    result: {
        error_code: 420, 
        description: 'Flood'
    }
}
```

Аргумент | Описание
------------ | -------------
`event_data` | В аргументе передаются данные подлежащие преобразованию в читаемый объект.


### Описание API для разработки на C
Описание будет добавлено позднее.

## Прочее
Дополнительную информацию вы сможете получить изучив код библиотеки.

## TO-DO
Позднее планируется добавление следующей функциональности:

- [ ] ReplyKeyboardMarkup
- [ ] InlineKeyboardMarkup